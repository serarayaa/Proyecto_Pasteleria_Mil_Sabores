# üì¶ DOCUMENTACI√ìN DE REPOSITORIOS - MIL SABORES v2.2.0

## üèóÔ∏è Arquitectura de Repositorios

El proyecto utiliza el **Pattern Repository** para abstraer la l√≥gica de acceso a datos. Esto permite separar la presentaci√≥n de la l√≥gica de negocio.

```
ViewModels
    ‚Üì
Repositories ‚Üê Abstracci√≥n de datos
    ‚Üì
Data Sources (Firebase, LocalStorage)
```

---

## üìã LISTA DE REPOSITORIOS

### 1. CarritoRepository
### 2. PedidosRepository
### 3. PedidosLocalStorage
### 4. AuthRepository
### 5. FirebaseAuthDataSource
### 6. RecordatorioRepository
### 7. MediaRepository

---

## 1Ô∏è‚É£ CarritoRepository

**Ubicaci√≥n:** `repository/CarritoRepository.kt`

### Responsabilidad
Gestionar el carrito de compras del usuario en memoria durante la sesi√≥n.

### M√©todos Principales

```kotlin
class CarritoRepository {
    // Propiedades observables
    val items: StateFlow<List<CarritoItem>>
    val cantidadTotal: StateFlow<Int>
    
    // Operaciones
    fun agregarProducto(item: CarritoItem)
    fun removerProducto(productoId: String)
    fun actualizarCantidad(productoId: String, nuevaCantidad: Int)
    fun limpiarCarrito()
    fun actualizarProducto(item: CarritoItem)
}
```

### Funcionamiento

```
1. agregarProducto()
   ‚îú‚îÄ Si producto existe: incrementar cantidad
   ‚îî‚îÄ Si no existe: agregar nuevo

2. removerProducto()
   ‚îî‚îÄ Filtrar y eliminar del carrito

3. actualizarCantidad()
   ‚îú‚îÄ Si cantidad > 0: actualizar
   ‚îî‚îÄ Si cantidad <= 0: remover

4. limpiarCarrito()
   ‚îî‚îÄ Vaciar carrito completamente
```

### Datos Guardados

```kotlin
data class CarritoItem(
    val productoId: String,
    val titulo: String,
    val precio: Double,
    val imagen: String,
    val cantidad: Int = 1
)
```

### Uso en ViewModel

```kotlin
class CarritoViewModel(
    private val repo: CarritoRepository = CarritoRepository.getInstance()
) {
    val items = repo.items // Observar items del carrito
    
    fun agregarProducto(item: CarritoItem) {
        repo.agregarProducto(item)
    }
}
```

### Persistencia
üî¥ **NO es persistente** - Se mantiene en memoria mientras la app est√° abierta.
Cuando cierras la app, el carrito se vac√≠a.

---

## 2Ô∏è‚É£ PedidosRepository

**Ubicaci√≥n:** `repository/PedidosRepository.kt`

### Responsabilidad
Gestionar pedidos en la base de datos Firestore (servidor).

### M√©todos Principales

```kotlin
class PedidosRepository(
    private val firestore: FirebaseFirestore = FirebaseFirestore.getInstance(),
    private val auth: FirebaseAuth = FirebaseAuth.getInstance()
) {
    // Crear pedido en servidor
    suspend fun crearPedido(pedido: Pedido): Result<String>
    
    // Observar cambios en tiempo real
    fun observarPedidosUsuario(): Flow<List<Pedido>>
    
    // Obtener un pedido espec√≠fico
    suspend fun obtenerPedido(pedidoId: String): Pedido?
    
    // Actualizar estado del pedido
    suspend fun actualizarPedido(pedido: Pedido)
}
```

### Funcionamiento

```
crearPedido(pedido):
1. Obtener UID del usuario autenticado
2. Generar ID √∫nico para el pedido
3. Crear estructura de datos con:
   - id, uid, fecha, productos, total, estado, observaciones
4. Guardar en Firestore: /pedidos/{pedidoId}
5. Retornar Result<String> con el ID

observarPedidosUsuario():
1. Crear listener en Firestore
2. Filtrar pedidos por uid actual
3. Ordenar por fecha descendente
4. Retornar Flow que notifica cambios en tiempo real
```

### Estructura en Firestore

```
/pedidos
  ‚îú‚îÄ pedido_1
  ‚îÇ  ‚îú‚îÄ id: "pedido_1"
  ‚îÇ  ‚îú‚îÄ uid: "usuario_123"
  ‚îÇ  ‚îú‚îÄ fecha: 1729000000000
  ‚îÇ  ‚îú‚îÄ total: 15000
  ‚îÇ  ‚îú‚îÄ estado: "PENDIENTE"
  ‚îÇ  ‚îú‚îÄ observaciones: "Sin frutos secos"
  ‚îÇ  ‚îî‚îÄ productos:
  ‚îÇ     ‚îú‚îÄ 0:
  ‚îÇ     ‚îÇ  ‚îú‚îÄ nombre: "Pastel Chocolate"
  ‚îÇ     ‚îÇ  ‚îú‚îÄ cantidad: 1
  ‚îÇ     ‚îÇ  ‚îî‚îÄ precio: 15000
  ‚îÇ     ‚îî‚îÄ ...
  ‚îî‚îÄ ...
```

### Persistencia
üü¢ **PERSISTENTE EN SERVIDOR** - Se guarda en Firestore y es recuperable siempre.

---

## 3Ô∏è‚É£ PedidosLocalStorage

**Ubicaci√≥n:** `data/local/PedidosLocalStorage.kt`

### Responsabilidad
Gestionar almacenamiento local de pedidos usando SharedPreferences + JSON.

### M√©todos Principales

```kotlin
class PedidosLocalStorage(private val context: Context) {
    // Guardar pedido localmente
    fun guardarPedido(pedido: Pedido): Result<String>
    
    // Obtener todos los pedidos
    fun obtenerTodosPedidos(): List<Pedido>
    
    // Obtener pedidos de un usuario
    fun obtenerPedidosUsuario(uid: String): List<Pedido>
    
    // Actualizar pedido
    fun actualizarPedido(pedido: Pedido): Result<String>
    
    // Obtener por ID
    fun obtenerPedidoPorId(pedidoId: String): Pedido?
    
    // Eliminar pedido
    fun eliminarPedido(pedidoId: String): Result<Boolean>
    
    // Limpiar todo
    fun limpiarTodos(): Result<Boolean>
}
```

### Funcionamiento

```
guardarPedido(pedido):
1. Obtener lista de pedidos actual (JSON)
2. Agregar nuevo pedido
3. Serializar a JSON usando GSON
4. Guardar en SharedPreferences
5. Retornar Result<String>

obtenerTodosPedidos():
1. Leer JSON de SharedPreferences
2. Deserializar usando GSON
3. Retornar lista de Pedido
```

### Almacenamiento

```
SharedPreferences
‚îú‚îÄ Key: "MilSaboresPedidos"
‚îî‚îÄ Value: [JSON array de pedidos]

Ejemplo JSON:
[
  {
    "id": "PEDIDO_1729000000000",
    "uid": "usuario_123",
    "fecha": 1729000000000,
    "productos": [
      {"nombre": "Pastel Chocolate", "cantidad": 1, "precio": 15000}
    ],
    "total": 15000,
    "estado": "PENDIENTE",
    "observaciones": ""
  },
  ...
]
```

### Persistencia
üü¢ **PERSISTENTE LOCALMENTE** - Se guarda en el dispositivo y persiste incluso al cerrar la app.

### Ventajas vs Firestore

| Aspecto | Firestore | LocalStorage |
|--------|-----------|--------------|
| Conexi√≥n | Requerida | No requerida |
| Velocidad | Segundos | Instant√°neo |
| Sincronizaci√≥n | Autom√°tica | Manual |
| Compartir datos | Entre dispositivos | Solo local |

---

## 4Ô∏è‚É£ AuthRepository

**Ubicaci√≥n:** `repository/auth/AuthRepository.kt`

### Responsabilidad
Gestionar autenticaci√≥n del usuario con Firebase.

### M√©todos Principales

```kotlin
class AuthRepository(
    private val auth: FirebaseAuth = FirebaseAuth.getInstance()
) {
    // Iniciar sesi√≥n
    suspend fun login(email: String, pass: String): User?
    
    // Crear nueva cuenta
    suspend fun register(email: String, pass: String): User?
    
    // Enviar reset de contrase√±a
    suspend fun sendPasswordReset(email: String)
    
    // Obtener usuario actual
    fun currentUser(): FirebaseUser?
    
    // Cerrar sesi√≥n
    fun signOut()
}
```

### Funcionamiento

```
login(email, pass):
1. Llamar Firebase Authentication
2. Validar credenciales
3. Si √©xito: retornar User con uid y email
4. Si fallo: lanzar excepci√≥n

register(email, pass):
1. Validar email y contrase√±a
2. Crear usuario en Firebase
3. Si √©xito: retornar User
4. Si fallo: lanzar excepci√≥n

signOut():
1. Cerrar sesi√≥n en Firebase
2. Limpiar token de autenticaci√≥n
```

### Usuario

```kotlin
data class User(
    val uid: String,      // Identificador √∫nico
    val email: String     // Email del usuario
)
```

### Seguridad

‚úÖ **Firebase Authentication valida:**
- Email v√°lido
- Contrase√±a m√≠nimo 6 caracteres
- No almacena contrase√±a en texto plano
- Encriptaci√≥n end-to-end

---

## 5Ô∏è‚É£ FirebaseAuthDataSource

**Ubicaci√≥n:** `repository/auth/FirebaseAuthDataSource.kt`

### Responsabilidad
Fuente de datos espec√≠fica para autenticaci√≥n (abstracci√≥n de Firebase).

### M√©todos Principales

```kotlin
class FirebaseAuthDataSource(
    private val auth: FirebaseAuth = FirebaseAuth.getInstance()
) {
    suspend fun login(email: String, password: String): AuthResult
    suspend fun register(email: String, password: String): AuthResult
    suspend fun sendPasswordReset(email: String)
    fun logout()
}

sealed class AuthResult {
    data class Success(val user: User) : AuthResult()
    data class Error(val exception: Exception) : AuthResult()
}
```

### Uso

```kotlin
// AuthRepository usa FirebaseAuthDataSource
class AuthRepository(
    private val dataSource: FirebaseAuthDataSource = FirebaseAuthDataSource()
) {
    suspend fun login(email: String, pass: String): User? {
        return when (val result = dataSource.login(email, pass)) {
            is AuthResult.Success -> result.user
            is AuthResult.Error -> throw result.exception
        }
    }
}
```

---

## 6Ô∏è‚É£ RecordatorioRepository

**Ubicaci√≥n:** `repository/auth/RecordatorioRepository.kt`

### Responsabilidad
Gestionar recordatorios/notificaciones del usuario.

### M√©todos Principales

```kotlin
class RecordatorioRepository {
    // Obtener todos los recordatorios
    fun obtenerRecordatorios(): Flow<List<Recordatorio>>
    
    // Crear nuevo recordatorio
    suspend fun crearRecordatorio(recordatorio: Recordatorio): Result<String>
    
    // Actualizar recordatorio
    suspend fun actualizarRecordatorio(recordatorio: Recordatorio)
    
    // Eliminar recordatorio
    suspend fun eliminarRecordatorio(id: String)
}

data class Recordatorio(
    val id: String,
    val titulo: String,
    val descripcion: String,
    val fecha: Long,
    val activo: Boolean
)
```

### Funcionamiento

```
obtenerRecordatorios():
1. Conectar con Firebase
2. Obtener recordatorios del usuario
3. Retornar Flow que notifica cambios

crearRecordatorio():
1. Generar ID √∫nico
2. Guardar en Firestore
3. Programar notificaci√≥n local
4. Retornar Result
```

---

## 7Ô∏è‚É£ MediaRepository

**Ubicaci√≥n:** `data/media/MediaRepository.kt`

### Responsabilidad
Gestionar media (fotos, videos) del usuario.

### M√©todos Principales

```kotlin
class MediaRepository {
    // Crear URI para imagen
    fun createImageUriForUser(context: Context, uid: String): Uri?
    
    // Guardar imagen
    suspend fun saveImageForUser(context: Context, uid: String, uri: Uri): Boolean
    
    // Obtener imagen del usuario
    fun getImageUriForUser(context: Context, uid: String): Uri?
    
    // Eliminar imagen
    fun deleteImageForUser(context: Context, uid: String): Boolean
}
```

### Funcionamiento

```
createImageUriForUser():
1. Crear ruta en almacenamiento interno
2. Generar nombre de archivo con UID
3. Crear URI v√°lida para la imagen

saveImageForUser():
1. Validar que URI existe
2. Copiar archivo a almacenamiento interno
3. Guardar ruta en preferencias
4. Retornar Boolean de √©xito

getImageUriForUser():
1. Recuperar URI de preferencias
2. Validar que archivo existe
3. Retornar URI o null
```

### Almacenamiento

```
/data/data/cl.duoc.milsabores/
‚îú‚îÄ files/
‚îÇ  ‚îî‚îÄ profile_photos/
‚îÇ     ‚îú‚îÄ usuario_1.jpg
‚îÇ     ‚îú‚îÄ usuario_2.jpg
‚îÇ     ‚îî‚îÄ ...
‚îî‚îÄ shared_prefs/
   ‚îî‚îÄ MilSaboresMediaPaths.xml
```

---

## üîÑ FLUJO COMPLETO: CREAR PEDIDO

```
Usuario ‚Üí CarritoScreen
    ‚Üì
Clic "Finalizar Pedido"
    ‚Üì
CarritoViewModel.finalizarCompra()
    ‚îú‚îÄ Validar carrito no vac√≠o
    ‚îú‚îÄ Convertir items a ProductoPedido
    ‚îî‚îÄ Crear objeto Pedido
        ‚Üì
    PedidosLocalStorage.guardarPedido()
        ‚îú‚îÄ Serializar a JSON
        ‚îú‚îÄ Guardar en SharedPreferences
        ‚îî‚îÄ Retornar pedidoId
        ‚Üì
    CarritoRepository.limpiarCarrito()
        ‚îî‚îÄ Vaciar carrito
        ‚Üì
    Navegar a "Mis Pedidos"
        ‚Üì
    PedidosLocalStorage.obtenerTodosPedidos()
        ‚îú‚îÄ Leer JSON
        ‚îú‚îÄ Deserializar
        ‚îî‚îÄ Mostrar en lista
```

---

## üèóÔ∏è RELACIONES ENTRE REPOSITORIOS

```
CarritoViewModel
‚îú‚îÄ CarritoRepository ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚Üí items (StateFlow)
‚îú‚îÄ PedidosLocalStorage ‚îÄ‚îÄ‚îÄ‚Üí guardarPedido()
‚îî‚îÄ PedidosObserverService ‚îÄ‚Üí notificaciones

ProfileViewModel
‚îú‚îÄ ProfilePhotoManager ‚îÄ‚îÄ‚îÄ‚Üí foto de perfil
‚îú‚îÄ MediaRepository ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚Üí almacenamiento media
‚îî‚îÄ FirebaseAuth ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚Üí usuario actual

LoginViewModel
‚îú‚îÄ AuthRepository ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚Üí login/register
‚îî‚îÄ FirebaseAuthDataSource ‚Üí autenticaci√≥n

PedidosViewModel
‚îú‚îÄ PedidosRepository ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚Üí pedidos servidor
‚îú‚îÄ PedidosLocalStorage ‚îÄ‚îÄ‚îÄ‚Üí pedidos locales
‚îî‚îÄ FirebaseAuth ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚Üí usuario actual
```

---

## üìä MATRIZ DE PERSISTENCIA

| Repositorio | Persistencia | Ubicaci√≥n | Acceso |
|-------------|-------------|-----------|--------|
| CarritoRepository | Memoria | RAM | R√°pido |
| PedidosLocalStorage | Local | SharedPreferences | Muy R√°pido |
| PedidosRepository | Servidor | Firestore | Necesita conexi√≥n |
| AuthRepository | Servidor | Firebase Auth | Necesita conexi√≥n |
| MediaRepository | Local | Almacenamiento interno | R√°pido |
| RecordatorioRepository | Servidor | Firestore | Necesita conexi√≥n |

---

## üîê PATRONES DE SEGURIDAD

```
AuthRepository
‚îú‚îÄ Valida credenciales con Firebase
‚îú‚îÄ No almacena contrase√±as
‚îî‚îÄ Usa tokens de sesi√≥n seguros

PedidosRepository
‚îú‚îÄ Solo accede a pedidos del usuario autenticado
‚îú‚îÄ Firestore Rules valida acceso
‚îî‚îÄ Datos encriptados en tr√°nsito

PedidosLocalStorage
‚îú‚îÄ Datos encriptados en dispositivo
‚îú‚îÄ Acceso solo por la aplicaci√≥n
‚îî‚îÄ SharedPreferences privado

MediaRepository
‚îú‚îÄ Almacenamiento interno (privado)
‚îú‚îÄ No accesible por otras apps
‚îî‚îÄ URI validadas antes de uso
```

---

## ‚úÖ RESUMEN

| Repositorio | Tipo | Persistencia | Uso |
|-------------|------|-------------|-----|
| CarritoRepository | Local | Memoria | Carrito temporal |
| PedidosRepository | Servidor | Firestore | Pedidos permanentes |
| PedidosLocalStorage | Local | SharedPreferences | Pedidos offline |
| AuthRepository | Servidor | Firebase Auth | Autenticaci√≥n |
| MediaRepository | Local | Almacenamiento | Fotos de usuario |
| RecordatorioRepository | Servidor | Firestore | Notificaciones |

**Arquitectura:** Clean Architecture con Repository Pattern
**Estado:** ‚úÖ **COMPLETAMENTE IMPLEMENTADO**
**Versi√≥n:** 2.2.0
**Fecha:** Octubre 2024

